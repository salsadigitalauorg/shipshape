collect:
  webform-files:
    file.lookup:
      path: config
      pattern: webform.webform.*.yml
      format: map-bytes
  webform-titles:
    yaml.keys:
      input: webform-files
      path: title
      format: map-string
  webform-handlers:
    yaml.keys:
      input: webform-files
      path: handlers
      format: map-yaml-nodes
  to-mail:
    yaml.keys:
      input: webform-handlers
      path: settings.to_mail
      format: map-nested-string
  cc-mail:
    yaml.keys:
      input: webform-handlers
      path: settings.cc_mail
      format: map-nested-string
  bcc-mail:
    yaml.keys:
      input: webform-handlers
      path: settings.bcc_mail
      format: map-nested-string

analyse:
  wrong-to-mail:
    regex-match:
      input: to-mail
      pattern: '\[(.*)\]'
      ignore: '[current-user]'
      breach-format:
        type: key-value
        key-label: webform
        key: $input("webform-titles")
        value-label: $inputName
        value: $self
  wrong-cc-mail:
    regex-match:
      input: cc-mail
      pattern: '\[(.*)\]'
      ignore: '[current-user]'
  wrong-bcc-mail:
    regex-match:
      input: bcc-mail
      pattern: '\[(.*)\]'
      ignore: '[current-user]'

output:
  stdout:
    format: json
  file:
    path: /results.junit
    format: junit
  lagoon.problems:
    api_key:
    api_endpoint:
