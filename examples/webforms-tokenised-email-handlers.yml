collect:
  webform-files:
    file.lookup:
      pattern: webform.webform.*.yml
      format: map-bytes
  webform-titles:
    yaml.keys:
      input: webform-files
      path: title
      format: map-string
  webform-handlers:
    yaml.keys:
      input: webform-files
      path: handlers
      format: map-yaml-nodes
  to-mail:
    yaml.keys:
      input: webform-handlers
      path: settings.to_mail
      format: map-nested-string
  cc-mail:
    yaml.keys:
      input: webform-handlers
      path: settings.cc_mail
      format: map-nested-string
  bcc-mail:
    yaml.keys:
      input: webform-handlers
      path: settings.bcc_mail
      format: map-nested-string

analyse:
  wrong-to-mail:
    regex-match:
      description: Found token in webform handler 'to:' email field
      input: to-mail
      pattern: '\[(.*)\]'
      ignore: '[current-user]'
      breach-format: &x-breach-format
        type: key-value
        key-label: webform
        key: ' {{ lookupFactAsStringMap "webform-titles" .Breach.Key }}'
        value-label: 'Handler "{{ .Breach.ValueLabel }}" has token'
        value: '{{ .Breach.Value }}'
  wrong-cc-mail:
    regex-match:
      description: Found token in webform handler 'cc:' email field
      input: cc-mail
      pattern: '\[(.*)\]'
      ignore: '[current-user]'
      breach-format: *x-breach-format
  wrong-bcc-mail:
    regex-match:
      description: Found token in webform handler 'bcc:' email field
      input: bcc-mail
      pattern: '\[(.*)\]'
      ignore: '[current-user]'
      breach-format: *x-breach-format

output:
  stdout:
    format: json
  file:
    path: /results.junit
    format: junit
  lagoon.problems:
    api_key:
    api_endpoint:
