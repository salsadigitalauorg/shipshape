collect:
  compose-file:
    file:read:
      path: docker-compose.yml

  # Extract the services nodes from the compose file.
  compose-services-nodes:
    yaml:key:
      input: compose-file
      path: services
      nodes-only: true

  # Extract the image for each service.
  images:
    yaml:key:
      input: compose-services-nodes
      path: image
  # Extract the Dockerfile for each service.
  dockerfile-paths:
    yaml:key:
      input: compose-services-nodes
      path: build.dockerfile
  # Extract the build arguments for each service.
  buildargs:
    yaml:key:
      input: compose-services-nodes
      path: build.args
  # Extract the environment variables for each service.
  envvars:
    yaml:key:
      input: compose-services-nodes
      path: environment

  # Read the dockerfiles.
  dockerfiles:
    file:read:multiple:
      input: dockerfile-paths

  # Extract the base image for each dockerfile.
  base-images:
    docker:images:
      input: dockerfiles
      additional-inputs: [buildargs]
      argsFrom: buildargs

analyse:
  disallowed-service-image:
    allowed-list:
      description: Disallowed image found in Docker Compose file.
      input: images
      # Extract the image name and tag.
      package-match: '^(.[^:@]*)?[:@]?([^ latest$]*)'
      allowed: &allowed-images
        - govcms/govcms
        - govcms/php
        - govcms/test
        - govcms/nginx-drupal
        - govcms/redis
        - govcms/solr
        - govcms/varnish-drupal
        - govcms/mariadb-drupal
        - govcms/av
        - uselagoon/php-8.1-cli-drupal
        - uselagoon/nginx-drupal
        - uselagoon/php-8.1-fpm
        - uselagoon/solr-7.7-drupal
        - uselagoon/varnish-drupal
        - uselagoon/redis-5
        - uselagoon/mariadb-drupal
      deprecated: &deprecated-images
        - govcms8lagoon/govcms
        - govcms8lagoon/php
        - govcms8lagoon/test
        - govcms8lagoon/nginx-drupal
        - govcms8lagoon/redis
        - govcms8lagoon/solr
        - govcms8lagoon/varnish-drupal
        - govcms8lagoon/mariadb-drupal
        - uselagoon/php-7.4-cli-drupal
        - uselagoon/php-7.4-fpm
      exclude-keys:
        - mariadb
        - chrome
  disallowed-base-image:
    allowed-list:
      description: Disallowed base image found in services' Dockerfiles.
      input: base-images
      allowed: *allowed-images
      deprecated: *deprecated-images

